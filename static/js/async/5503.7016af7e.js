"use strict";(self.webpackChunknote=self.webpackChunknote||[]).push([["5503"],{5367:function(e,n,r){r.r(n),r.d(n,{default:()=>a});var t=r(5893),o=r(65);function c(e){let n=Object.assign({h1:"h1",a:"a",h2:"h2",p:"p",code:"code",pre:"pre"},(0,o.ah)(),e.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.h1,{id:"全局api",children:[(0,t.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#全局api",children:"#"}),"全局API"]}),"\n",(0,t.jsxs)(n.h2,{id:"vue3入口-createapp",children:[(0,t.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#vue3入口-createapp",children:"#"}),"Vue3入口-createApp"]}),"\n",(0,t.jsxs)(n.p,{children:["相比较于",(0,t.jsx)(n.code,{children:"Vue 2"}),"通过构造函数",(0,t.jsx)(n.code,{children:"new Vue()"}),"的方式创建根",(0,t.jsx)(n.code,{children:"Vue"}),"实例，",(0,t.jsx)(n.code,{children:"Vue 3"}),"改为了通过调用 ",(0,t.jsx)(n.code,{children:"createApp"}),"返回一个应用实例："]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"import { createApp } from 'vue'\nimport App from './App.vue'\n\ncreateApp(App).mount('#app')\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"createApp"}),"源码位于",(0,t.jsx)(n.code,{children:"@vue/runtime-dom/src/index.ts"}),"："]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"export const createApp = ((...args) => {\n  // 调用render.createApp生成app\n  const app = ensureRenderer().createApp(...args)\n\n  // 重新包装app的mount方法\n  const { mount } = app\n  app.mount = (containerOrSelector: Element | string): any => {\n    const container = normalizeContainer(containerOrSelector)\n    if (!container) return\n    const component = app._component\n    if (!isFunction(component) && !component.render && !component.template) {\n      component.template = container.innerHTML\n    }\n    // clear content before mounting\n    container.innerHTML = ''\n    const proxy = mount(container)\n    container.removeAttribute('v-cloak')\n    container.setAttribute('data-v-app', '')\n    return proxy\n  }\n\n  return app\n}) as CreateAppFunction<Element>\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"ensureRenderer"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"// lazy create the renderer - this makes core renderer logic tree-shakable\n// in case the user only imports reactivity utilities from Vue.\nlet renderer: Renderer<Element> | HydrationRenderer\n\nlet enabledHydration = false\n\nfunction ensureRenderer() {\n  return renderer || (renderer = createRenderer<Node, Element>(rendererOptions))\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"createRenderer"}),"位于",(0,t.jsx)(n.code,{children:"@vue/runtime-core/renderer.ts"}),"，调用了同文件的",(0,t.jsx)(n.code,{children:"baseCreateRenderer"}),"，其代码如下："]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"function baseCreateRenderer(\n  options: RendererOptions,\n  createHydrationFns?: typeof createHydrationFunctions\n): any {\n  //... 无关代码省略\n\n  return {\n    render,\n    hydrate,\n    createApp: createAppAPI(render, hydrate)\n  }\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["因为在",(0,t.jsx)(n.code,{children:"createApp"}),"中只使用到了",(0,t.jsx)(n.code,{children:"render.createApp"}),"，所以我们把无关代码省略，可以看到",(0,t.jsx)(n.code,{children:"render.createApp"}),"是由",(0,t.jsx)(n.code,{children:"createAppAPI"}),"生成的，代码位于",(0,t.jsx)(n.code,{children:"@vue/runtime-core/apiCreateApp.ts"}),"第114行，其作用是返回一个",(0,t.jsx)(n.code,{children:"createApp"}),"方法，用于生成一个",(0,t.jsx)(n.code,{children:"AppContext"}),"和一个",(0,t.jsx)(n.code,{children:"App"}),"，其作用相当于",(0,t.jsx)(n.code,{children:"Vue2"}),"的",(0,t.jsx)(n.code,{children:"new Vue()"}),"，代码如下："]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"export function createAppAPI<HostElement>(\n  render: RootRenderFunction,\n  hydrate?: RootHydrateFunction\n): CreateAppFunction<HostElement> {\n  return function createApp(rootComponent, rootProps = null) {\n    // 确保rootProps只能是null或者Object\n    if (rootProps != null && !isObject(rootProps)) {\n      rootProps = null\n    }\n\n    const context = createAppContext()\n    const installedPlugins = new Set()\n\n    let isMounted = false\n\n    const app: App = (context.app = {\n      // ... app对象内容省略\n    })\n\n    return app\n  }\n}\n"})}),"\n",(0,t.jsxs)(n.h2,{id:"app的mount过程",children:[(0,t.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#app的mount过程",children:"#"}),"App的mount过程"]}),"\n",(0,t.jsxs)(n.p,{children:["由于在",(0,t.jsx)(n.code,{children:"@vue/runtime-dom/src/index.ts"}),"的",(0,t.jsx)(n.code,{children:"createApp"}),"函数中重写了",(0,t.jsx)(n.code,{children:"app.mount"}),"方法，所以",(0,t.jsx)(n.code,{children:"App"}),"的",(0,t.jsx)(n.code,{children:"mount"}),"入口在这里："]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"// @vue/runtime-dom/src/index.ts 61行\napp.mount = (containerOrSelector: Element | string): any => {\n  // 如果是选择器，则返回对应的dom\n  const container = normalizeContainer(containerOrSelector)\n  if (!container) return\n  \n  // clear content before mounting\n  container.innerHTML = ''\n\n  const proxy = mount(container)\n  \n  container.removeAttribute('v-cloak')\n  container.setAttribute('data-v-app', '')\n  return proxy\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["主要做了以下的操作，将选择器转行成",(0,t.jsx)(n.code,{children:"DOM"}),"，将",(0,t.jsx)(n.code,{children:"container"}),"清空，调用",(0,t.jsx)(n.code,{children:"app"}),"原来的",(0,t.jsx)(n.code,{children:"mount"}),"方法，并对",(0,t.jsx)(n.code,{children:"DOM"}),"的属性做了一些操作"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"app"}),"原来的",(0,t.jsx)(n.code,{children:"mount"}),"方法位于",(0,t.jsx)(n.code,{children:"@vue/runtime-core/apiCreateApp.ts"}),"的",(0,t.jsx)(n.code,{children:"createAppAPI"}),"中，其主要内容为，将",(0,t.jsx)(n.code,{children:"App"}),"组件内容生成",(0,t.jsx)(n.code,{children:"VNode"}),"，将",(0,t.jsx)(n.code,{children:"vnode.appContext"}),"设置上，调用",(0,t.jsx)(n.code,{children:"render(vnode, rootContainer)"}),"渲染组件，将闭包里的",(0,t.jsx)(n.code,{children:"isMounted"}),"设置成",(0,t.jsx)(n.code,{children:"true"}),"，将",(0,t.jsx)(n.code,{children:"rootContainer"}),"设置给",(0,t.jsx)(n.code,{children:"app._container"}),"，将",(0,t.jsx)(n.code,{children:"vnode.component!.proxy"}),"返回。"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"function createApp(rootComponent, rootProps = null) {\n  // 其他内容省略\n  const context = createAppContext()\n  let isMounted = false\n\n  const app: App = (context.app = {\n    // ... 其他app对象内容省略\n    mount(rootContainer: HostElement, isHydrate?: boolean): any {\n      if (!isMounted) {\n        const vnode = createVNode(\n          rootComponent as ConcreteComponent,\n          rootProps\n        )\n        // store app context on the root VNode.\n        // this will be set on the root instance on initial mount.\n        vnode.appContext = context\n\n        render(vnode, rootContainer)\n\n        isMounted = true\n        app._container = rootContainer\n        \n        return vnode.component!.proxy\n      }\n      // else if 内容为开发环境报警\n    },\n  })\n}\n"})})]})}function p(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,o.ah)(),e.components);return n?(0,t.jsx)(n,Object.assign({},e,{children:(0,t.jsx)(c,e)})):c(e)}let a=p;p.__RSPRESS_PAGE_META={},p.__RSPRESS_PAGE_META["framework%2Fvue3%2Fapi.md"]={toc:[{id:"vue3入口-createapp",text:"Vue3入口-createApp",depth:2},{id:"app的mount过程",text:"App的mount过程",depth:2}],title:"全局API",headingTitle:"全局API",frontmatter:{}}}}]);